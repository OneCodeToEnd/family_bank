# 预算管理功能需求文档

## 1. 功能概述

预算管理功能帮助用户设定年度支出预算，系统自动生成月度预算并监控执行情况。

**核心价值**：一次配置全年预算，每月自动监控，简单实用。

## 2. 核心功能

### 2.1 年度预算配置

**功能描述**：为支出分类设定年度预算，系统自动按月平均

**操作流程**：
1. 进入"预算管理"页面
2. 点击"设置年度预算"
3. 选择年份（如：2026年）
4. 为各支出分类设置年度预算金额
   - 餐饮：36000元/年 → 自动生成 3000元/月
   - 交通：6000元/年 → 自动生成 500元/月
5. 保存后自动生成12个月的月度预算

**规则**：
- 年度预算金额必须 > 0
- 仅支持支出类别（收入类别不支持）
- 月度预算 = 年度预算 ÷ 12（四舍五入到分）
- 同一分类同一年份只能有一个年度预算

### 2.2 月度预算监控

**功能描述**：展示当月各分类预算执行情况

**展示内容**：
- 当前月份（如：2026年1月）
- 预算列表（按分类）
  - 分类名称和图标
  - 月度预算金额（年度预算÷12）
  - 已用金额（当月实际支出）
  - 剩余金额
  - 使用进度条

**状态标识**：
- 正常：已用 < 80%（绿色）
- 预警：80% ≤ 已用 < 100%（黄色）
- 超支：已用 ≥ 100%（红色）

### 2.3 超支提醒

**提醒时机**：
- 某分类当月支出达到预算的 80% 时提醒
- 某分类当月支出超过预算时提醒
- 每个分类每月仅提醒一次

**提醒方式**：应用内弹窗

## 3. 数据模型

### 3.1 年度预算表（annual_budgets）

```sql
CREATE TABLE annual_budgets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  family_id INTEGER NOT NULL,
  category_id INTEGER NOT NULL,
  year INTEGER NOT NULL,           -- 2026
  annual_amount REAL NOT NULL,     -- 36000
  monthly_amount REAL NOT NULL,    -- 3000 (自动计算)
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  UNIQUE(family_id, category_id, year),
  FOREIGN KEY (family_id) REFERENCES family_groups(id),
  FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

### 3.2 月度预算使用统计

实时从 `transactions` 表计算：
- 筛选：当月 + 对应分类 + 支出类型
- 统计：SUM(amount)

## 4. 界面设计

### 4.1 预算管理主页

**入口**：首页 → 预算 或 设置 → 预算管理

**页面结构**：
```
┌─────────────────────────────┐
│ 2026年预算                   │
│ [上一年] 2026年 [下一年]      │
│ 总预算: ¥50,000  已配置: 5项  │
│ [设置年度预算]               │
└─────────────────────────────┘

┌─────────────────────────────┐
│ 当月执行情况 (2026年1月)     │
│                             │
│ [餐饮图标] 餐饮              │
│ 预算: ¥3,000  已用: ¥2,400   │
│ [████████░░] 80%            │
│                             │
│ [交通图标] 交通              │
│ 预算: ¥500   已用: ¥320      │
│ [██████░░░░] 64%            │
│                             │
│ ...                         │
└─────────────────────────────┘
```

### 4.2 年度预算配置页面

**表单结构**：
```
┌─────────────────────────────┐
│ 设置 2026年 预算             │
│                             │
│ [餐饮] ¥ [36000] /年         │
│        → 3000元/月           │
│                             │
│ [交通] ¥ [6000] /年          │
│        → 500元/月            │
│                             │
│ [购物] ¥ [12000] /年         │
│        → 1000元/月           │
│                             │
│ [添加更多分类]               │
│                             │
│ [保存]  [取消]               │
└─────────────────────────────┘
```

## 5. 业务规则

1. **预算配置**
   - 同一分类同一年份只能配置一次
   - 修改年度预算后，未来月份的月度预算自动更新
   - 已过去的月份预算不受影响

2. **预算计算**
   - 月度预算 = 年度预算 ÷ 12
   - 已用金额 = 当月该分类所有支出交易的总和
   - 剩余金额 = 月度预算 - 已用金额

3. **预算周期**
   - 每年1月1日开始新的预算年度
   - 上一年度预算不自动延续（需重新配置）

## 6. 实现步骤

### 第一步：数据库
- 创建 `annual_budgets` 表
- 添加数据库迁移（V7）

### 第二步：Service 层
- `AnnualBudgetDbService` - 年度预算 CRUD
- `BudgetCalculationService` - 计算月度使用情况

### 第三步：Provider 层
- `BudgetProvider` - 管理预算状态和业务逻辑

### 第四步：UI 层
- `BudgetOverviewScreen` - 预算概览页面
- `AnnualBudgetFormScreen` - 年度预算配置页面
- `MonthlyBudgetCard` - 月度预算卡片组件

### 第五步：集成
- 在首页添加预算入口
- 在设置页面添加预算管理入口
- 实现超支提醒逻辑

## 7. 测试要点

- 年度预算配置和月度预算自动生成
- 月度预算使用金额计算准确性
- 跨年份预算隔离
- 超支状态判断
- 修改年度预算后月度预算更新

## 8. 未来扩展

- 预算模板（快速复制上一年预算）
- 预算执行报告（年度/月度对比）
- 灵活调整（某月单独调整预算）
- 家庭成员预算分配
