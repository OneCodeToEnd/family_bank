# 备份功能使用说明

## 功能概述

账清应用现已支持完整的备份和恢复功能，包括：
- 手动创建备份
- 导出备份文件（可通过微信、邮件等分享）
- 导入备份文件
- 自动定时备份
- 备份历史管理

## 使用方法

### 1. 访问备份管理

打开应用 → 设置 → 数据管理 → 备份管理

### 2. 创建备份

点击「立即备份」按钮，系统会创建当前数据的完整备份。

### 3. 导出备份

点击「导出备份」按钮，系统会：
1. 创建一个新的备份文件
2. 打开系统分享界面
3. 你可以选择通过微信、邮件、AirDrop 等方式发送备份文件

### 4. 导入备份

点击「导入备份」按钮，系统会：
1. 打开文件选择器
2. 选择之前导出的 .db 备份文件
3. 验证备份文件的完整性
4. 替换当前数据（会先备份当前数据以防失败）

**注意：** 导入备份会替换所有当前数据，建议先导出当前数据作为备份。

### 5. 恢复历史备份

在「备份历史」列表中：
- 点击备份项右侧的菜单按钮
- 选择「恢复」
- 确认后即可恢复到该备份的状态

### 6. 自动备份设置

启用「自动备份」开关后：
- 应用每次启动时会自动检查是否需要备份
- 可以设置备份频率（1天、3天、7天等）
- 可以设置保留备份数量（自动清理旧备份）

## 备份文件说明

- 备份文件格式：`.db` (SQLite 数据库文件)
- 文件命名：`backup_时间戳.db`
- 存储位置：应用文档目录/backups/
- 文件大小：通常在几百 KB 到几 MB 之间

## 多设备同步方案

### 方案 1：手动同步（推荐）

1. 在设备 A 上导出备份
2. 通过微信/邮件发送到设备 B
3. 在设备 B 上导入备份

### 方案 2：云盘同步

1. 启用自动备份
2. 将备份文件夹同步到 iCloud/Google Drive
3. 在其他设备上下载最新备份并导入

### 方案 3：WebDAV 同步（待实现）

未来版本将支持 WebDAV 协议，可以自动同步到：
- 自建的 Nextcloud/ownCloud
- 坚果云
- NAS 设备

## 注意事项

1. **定期备份**：建议每周至少备份一次
2. **多地备份**：重要数据建议保存多份备份到不同位置
3. **验证备份**：导出备份后，建议在其他设备上测试导入
4. **数据安全**：备份文件包含所有财务数据，请妥善保管

## 故障排除

### 导入失败

- 检查备份文件是否完整（未损坏）
- 确保备份文件是从账清应用导出的
- 尝试重新导出备份

### 自动备份不工作

- 检查是否启用了自动备份开关
- 检查备份频率设置
- 查看最后备份时间，确认是否已到备份时间

### 备份文件找不到

- 备份文件存储在应用私有目录
- 需要通过「导出备份」功能才能访问
- 不要直接在文件管理器中查找

## 技术实现

### 架构设计

```
lib/
├── models/backup/
│   ├── backup_info.dart          # 备份信息模型
│   └── backup_settings.dart      # 备份设置模型
├── services/backup/
│   ├── backup_service.dart       # 基础备份服务
│   ├── export_import_service.dart # 导出导入服务
│   └── auto_backup_service.dart  # 自动备份服务
├── providers/backup/
│   └── backup_provider.dart      # 备份状态管理
└── screens/settings/backup/
    └── backup_management_screen.dart # 备份管理UI
```

### 核心功能

1. **备份创建**：直接复制 SQLite 数据库文件
2. **备份验证**：检查必要的表是否存在
3. **备份恢复**：替换数据库文件前先备份当前数据
4. **自动清理**：保留最近 N 个备份，自动删除旧备份
5. **错误处理**：恢复失败时自动回滚到原数据

### 扩展性

代码设计预留了 WebDAV 同步的扩展接口，未来可以轻松添加：
- WebDAV 服务器配置
- 自动上传/下载
- 冲突检测和解决

## 更新日志

### v1.0.0+9 (2024-01-15)
- ✅ 实现基础备份功能
- ✅ 实现导出/导入功能
- ✅ 实现自动备份功能
- ✅ 实现备份历史管理
- ✅ 集成到设置页面

### 未来计划
- [ ] WebDAV 同步支持
- [ ] 备份加密功能
- [ ] 增量备份支持
- [ ] 云端备份支持（iCloud/Google Drive）
