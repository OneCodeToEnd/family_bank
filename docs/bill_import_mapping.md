# 账单导入字段映射文档

本文档详细说明了支付宝交易明细和微信支付账单与应用数据库表的字段对应关系。

---

## 一、支付宝交易明细（CSV 格式）

### 1.1 文件特征
- **文件格式**：CSV
- **编码格式**：GBK
- **表头行数**：24 行（前 24 行为文件信息，从第 25 行开始为数据）
- **数据分隔符**：逗号 (`,`)

### 1.2 支付宝 CSV 表头字段
```
交易号,商家订单号,交易创建时间,付款时间,最近修改时间,交易来源地,
类型,交易对方,商品名称,金额（元）,收/支,交易状态,服务费（元）,
成功退款（元）,备注,资金状态
```

### 1.3 字段映射关系

| 支付宝字段 | 数据库字段 | 字段类型 | 映射逻辑 | 示例 |
|-----------|-----------|---------|---------|------|
| 交易号 | - | - | 不存储，仅用于日志 | 2024121312345678901234567890 |
| 商家订单号 | - | - | 不存储 | - |
| 交易创建时间 | `transaction_time` | INTEGER | 解析为时间戳 | "2024-12-13 14:30:00" → 1702454400000 |
| 付款时间 | - | - | 不使用，优先使用交易创建时间 | - |
| 最近修改时间 | `updated_at` | INTEGER | 解析为时间戳 | 1702454400000 |
| 交易来源地 | - | - | 不存储 | 其他（包括阿里巴巴、优酷、高德等） |
| 类型 | `type` | TEXT | 映射为 income/expense | "收入" → income, "支出" → expense |
| 交易对方 | `description` | TEXT | 作为描述的一部分 | "某某商家" |
| 商品名称 | `description` | TEXT | 与交易对方合并为描述 | "早餐" |
| 金额（元） | `amount` | REAL | 直接存储 | "25.50" → 25.50 |
| 收/支 | `type` | TEXT | 映射为 income/expense | "支出" → expense |
| 交易状态 | - | BOOLEAN | 用于过滤，仅导入成功交易 | "交易成功" → 导入 |
| 服务费（元） | - | - | 不存储 | - |
| 成功退款（元） | - | - | 不存储 | - |
| 备注 | `description` | TEXT | 追加到描述末尾 | "备注信息" |
| 资金状态 | - | - | 不存储 | "已收入" |

### 1.4 特殊处理逻辑

#### 描述字段生成规则
```
description = "[交易对方] [商品名称]" + (备注 ? " - [备注]" : "")
```

示例：
- 交易对方："某某超市"
- 商品名称："生活用品"
- 备注："月度采购"
- 生成描述：`"某某超市 生活用品 - 月度采购"`

#### 交易状态过滤
只导入以下状态的交易：
- ✅ "交易成功"
- ✅ "支付成功"
- ❌ "交易关闭" - 不导入
- ❌ "等待买家付款" - 不导入

#### 去重机制
```dart
// 生成去重哈希
final hash = md5.convert(
  utf8.encode('${timestamp}_${amount}_${description}')
).toString();
```

---

## 二、微信支付账单（Excel 格式）

### 2.1 文件特征
- **文件格式**：Excel (.xlsx)
- **编码格式**：UTF-8
- **表头行数**：17 行（前 17 行为文件信息，从第 18 行开始为数据）
- **金额格式**：`¥123.45`（带货币符号和千分位逗号）

### 2.2 微信 Excel 表头字段
```
交易时间,交易类型,交易对方,商品,收/支,金额(元),支付方式,
当前状态,交易单号,商户单号,备注
```

### 2.3 字段映射关系

| 微信字段 | 数据库字段 | 字段类型 | 映射逻辑 | 示例 |
|---------|-----------|---------|---------|------|
| 交易时间 | `transaction_time` | INTEGER | 解析为时间戳 | "2024-12-13 14:30:00" → 1702454400000 |
| 交易类型 | - | - | 用于过滤和分类 | "商户消费", "微信红包", "二维码收款" |
| 交易对方 | `description` | TEXT | 作为描述的一部分 | "某某餐厅" |
| 商品 | `description` | TEXT | 与交易对方合并为描述 | "午餐" |
| 收/支 | `type` | TEXT | 映射为 income/expense | "支出" → expense, "收入" → income |
| 金额(元) | `amount` | REAL | 去除符号和逗号后存储 | "¥1,234.56" → 1234.56 |
| 支付方式 | - | - | 不存储 | "零钱通" |
| 当前状态 | - | BOOLEAN | 用于过滤，仅导入成功交易 | "支付成功" → 导入 |
| 交易单号 | - | - | 不存储，仅用于日志 | 1000050201202412130123456789 |
| 商户单号 | - | - | 不存储 | - |
| 备注 | `description` | TEXT | 追加到描述末尾 | "生日礼物" |

### 2.4 特殊处理逻辑

#### 金额格式处理
```dart
// 去除 ¥ 符号
String cleanAmount = amount.replaceAll('¥', '');
// 去除千分位逗号
cleanAmount = cleanAmount.replaceAll(',', '');
// 转换为数字
double finalAmount = double.parse(cleanAmount);
```

示例：
- 原始金额：`"¥1,234.56"`
- 处理后：`1234.56`

#### 描述字段生成规则
```
description = "[交易对方] [商品]" + (备注 ? " - [备注]" : "")
```

示例：
- 交易对方："某某商城"
- 商品："电子产品"
- 备注："618购物"
- 生成描述：`"某某商城 电子产品 - 618购物"`

#### 交易状态过滤
只导入以下状态的交易：
- ✅ "支付成功"
- ✅ "已支付"
- ✅ "已转账"
- ✅ "已存入零钱"
- ✅ "已收钱"
- ❌ "已退款" - 不导入
- ❌ "已关闭" - 不导入
- ❌ "未支付" - 不导入

#### 去重机制
与支付宝相同：
```dart
final hash = md5.convert(
  utf8.encode('${timestamp}_${amount}_${description}')
).toString();
```

---

## 三、数据库表结构

### 3.1 transactions 表结构

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| `id` | INTEGER | PRIMARY KEY | 自增主键 |
| `account_id` | INTEGER | NOT NULL | 关联账户 ID |
| `category_id` | INTEGER | NULL | 关联分类 ID（可为空） |
| `type` | TEXT | NOT NULL | 收支类型：income/expense |
| `amount` | REAL | NOT NULL | 金额 |
| `description` | TEXT | NULL | 描述信息 |
| `transaction_time` | INTEGER | NOT NULL | 交易时间戳（毫秒） |
| `import_source` | TEXT | NOT NULL | 导入来源：manual/alipay/wechat/photo |
| `hash` | TEXT | UNIQUE | 去重哈希值（MD5） |
| `is_confirmed` | INTEGER | DEFAULT 0 | 是否已确认分类：0=未确认, 1=已确认 |
| `created_at` | INTEGER | NOT NULL | 创建时间戳 |
| `updated_at` | INTEGER | NOT NULL | 更新时间戳 |

### 3.2 默认值设置

导入时的默认值：
- `account_id`: 用户选择的账户 ID
- `category_id`: NULL（未分类，待用户手动分类或自动分类）
- `import_source`:
  - 支付宝：`"alipay"`
  - 微信：`"wechat"`
- `is_confirmed`: `0`（未确认，需要用户审核）
- `created_at` / `updated_at`: 当前时间戳

---

## 四、导入流程

### 4.1 支付宝 CSV 导入流程

```
1. 用户选择平台：支付宝
   ↓
2. 用户选择账户
   ↓
3. 用户选择 CSV 文件
   ↓
4. 读取文件（使用 GBK 编码）
   ↓
5. 跳过前 24 行表头
   ↓
6. 逐行解析数据：
   - 验证交易状态（只处理成功交易）
   - 解析时间字段
   - 解析金额
   - 生成描述
   - 计算去重哈希
   ↓
7. 去重检查（通过 hash 字段）
   ↓
8. 批量插入数据库
   ↓
9. 显示导入结果（成功数/重复数）
```

### 4.2 微信 Excel 导入流程

```
1. 用户选择平台：微信
   ↓
2. 用户选择账户
   ↓
3. 用户选择 Excel 文件
   ↓
4. 读取文件（使用 excel 库）
   ↓
5. 跳过前 17 行表头
   ↓
6. 逐行解析数据：
   - 验证交易状态（只处理成功交易）
   - 解析时间字段
   - 处理金额格式（去除 ¥ 和逗号）
   - 生成描述
   - 计算去重哈希
   ↓
7. 去重检查（通过 hash 字段）
   ↓
8. 批量插入数据库
   ↓
9. 显示导入结果（成功数/重复数）
```

---

## 五、实现代码位置

### 5.1 核心文件

| 文件 | 路径 | 功能 |
|------|------|------|
| 导入服务 | `lib/services/import/bill_import_service.dart` | CSV/Excel 解析逻辑 |
| 导入页面 | `lib/screens/import/bill_import_screen.dart` | 用户界面 |
| 数据库服务 | `lib/services/database/transaction_db_service.dart` | 批量插入和去重 |
| Transaction 模型 | `lib/models/transaction.dart` | 数据模型定义 |

### 5.2 关键方法

#### 支付宝导入
```dart
// lib/services/import/bill_import_service.dart
Future<List<Transaction>> importAlipayCSV(
  File file,
  int accountId,
) async {
  // 实现逻辑
}
```

#### 微信导入
```dart
// lib/services/import/bill_import_service.dart
Future<List<Transaction>> importWeChatExcel(
  File file,
  int accountId,
) async {
  // 实现逻辑
}
```

#### 批量插入
```dart
// lib/services/database/transaction_db_service.dart
Future<Map<String, dynamic>> createTransactionsBatch(
  List<Transaction> transactions,
) async {
  // 去重并批量插入
}
```

---

## 六、注意事项

### 6.1 数据一致性
- ✅ 导入前必须选择账户
- ✅ 所有导入的账单初始状态为"未分类"
- ✅ 使用 MD5 哈希防止重复导入
- ✅ 只导入交易状态为"成功"的记录

### 6.2 字符编码
- ⚠️ 支付宝 CSV 使用 GBK 编码，必须使用 `charset` 库转换
- ✅ 微信 Excel 使用 UTF-8，无需特殊处理

### 6.3 日期时间格式
- 支付宝格式：`"YYYY-MM-DD HH:mm:ss"`
- 微信格式：`"YYYY-MM-DD HH:mm:ss"`
- 存储格式：INTEGER 时间戳（毫秒）

### 6.4 金额处理
- 支付宝：直接为数字字符串，如 `"123.45"`
- 微信：包含货币符号和逗号，如 `"¥1,234.56"`
- 存储格式：REAL 浮点数

### 6.5 性能优化
- ✅ 使用批量插入 (batch insert)
- ✅ 事务处理确保原子性
- ✅ 逐行解析避免内存溢出
- ✅ 解析失败的行不影响其他行

---

## 七、扩展支持

### 7.1 未来支持的格式

| 平台 | 文件格式 | 优先级 | 状态 |
|------|---------|--------|------|
| 支付宝 | CSV | P0 | ✅ 已实现 |
| 微信支付 | Excel | P0 | ⚠️ 代码已写，待测试 |
| 银行卡 | CSV/Excel | P1 | 📝 计划中 |
| 京东支付 | Excel | P2 | 📝 计划中 |
| 云闪付 | CSV | P2 | 📝 计划中 |

### 7.2 自定义字段映射
未来可以支持用户自定义字段映射配置，以适应不同银行和支付平台的导出格式。

---

## 八、测试建议

### 8.1 测试用例

#### 支付宝测试
1. ✅ 正常 CSV 文件
2. ✅ 包含特殊字符的描述
3. ✅ 大额交易（测试金额精度）
4. ✅ 重复导入（测试去重）
5. ✅ 编码测试（GBK 中文字符）

#### 微信测试
1. ⚠️ 正常 Excel 文件
2. ⚠️ 包含千分位的大额金额
3. ⚠️ 不同交易类型
4. ⚠️ 重复导入（测试去重）
5. ⚠️ 特殊状态交易

### 8.2 边界情况
- 空文件处理
- 格式错误文件
- 超大文件（>1000 条记录）
- 网络中断后恢复
- 并发导入

---

## 九、常见问题

### Q1: 为什么导入的账单都显示"未分类"？
**A**: 这是设计行为。导入的账单 `category_id` 为 NULL，`is_confirmed` 为 0，需要用户手动分类或使用自动分类功能。

### Q2: 如何避免重复导入？
**A**: 系统使用 MD5 哈希值（基于时间+金额+描述）来检测重复。相同的交易会被自动跳过。

### Q3: 支付宝 CSV 显示乱码怎么办？
**A**: 确保使用正确的编码（GBK）。代码中已自动处理，如果仍有问题，检查文件是否被其他软件修改过。

### Q4: 微信 Excel 金额不正确？
**A**: 检查 Excel 中的金额格式。系统会自动去除 `¥` 符号和逗号，但如果格式特殊可能需要手动调整。

### Q5: 为什么有些交易没有导入？
**A**: 只有交易状态为"成功"的记录才会被导入。失败、关闭、退款的交易会被自动过滤。

---

## 十、更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0 | 2024-12-15 | 初始版本，支持支付宝 CSV 导入 |
| 1.1 | 2024-12-15 | 添加微信 Excel 导入支持（待测试） |

---

**文档维护者**: Claude
**最后更新**: 2024-12-15
**项目**: 账清 (Family Bank) - 个人账单流水分析APP
